<!DOCTYPE html>
<html>
	<head>
	<?php $this->load->view('t_head');?>
	</head>
	<body class="hold-transition skin-black-light sidebar-mini fixed">
	<div class="wrapper">
		<?php $this->load->view('t_navbar');?>
		<?php $this->load->view('t_menu_left');?>
		<div class="content-wrapper">
		<section class="content-header">
			<h1><?php if(isset($page_title)) { echo $page_title; } ?></h1>
			<ol class="breadcrumb">
				<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
				<li><a href="#">UI</a></li>
				<li class="active">Tampil Data</li>
			</ol>
		</section>
		<section class="content">
			<div class="panel box box-success">
				<div class="box-header with-border">
				<h4 class="box-title">
					<a data-toggle="collapse" href="#editData" class="" aria-expanded="true">
					<i class="fa fa-list"></i>
					Daftar <?php if(isset($page_title)) { echo $page_title; } ?>
					</a>
				</h4>
				<button type="button" onclick="reloadTable()" class="btn btn-xs btn-info pull-right"><i class="fa fa-refresh"></i> Reload</button>
				</div>
				<div id="editData" class="panel-collapse collapse in" aria-expanded="true" style="">
					<div class="box-body">
						<table id="listDataTable" class="table table-bordered">
						<thead>
							<tr>
								<th>Kategori</th>
								<th>Data</th>
								<!-- <th>Aktif</th> -->
								<th width="200">Aksi</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
						</table>
					</div>
				</div>
			</div>
		</section>
		</div>
		
		<div class="modal fade" id="viewModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<form action="#" class="form-horizontal" method="POST">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">×</span></button>
							<h4 class="modal-title">Detail </h4>
						</div>
						<div class="modal-body">
							<div class="box-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">Id Report</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_id_report">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Dapen</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_id_dapen">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Data</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_id_data">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Data</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_data">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Tahun</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_tahun">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Bulan</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_bulan">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Aktif</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="V_aktif">
									</div>
								</div>

							</div>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="modal fade" id="editModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<form action="#" class="form-horizontal" method="POST">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">×</span></button>
							<h4 class="modal-title">Detail </h4>
						</div>
						<div class="modal-body">
							<div class="box-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">Id Report</label>
									<div class="col-sm-10">
										<input type="text" disabled="" class="form-control" name="E_id_report">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Dapen</label>
									<div class="col-sm-10">
										<input type="hidden" name="E_id_dapen">
										<select id="E_FK_id_dapen" onchange="submit_e_fk_id_dapen()"></select>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Data</label>
									<div class="col-sm-10">
										<input type="hidden" name="E_id_data">
										<select id="E_FK_id_data" onchange="submit_e_fk_id_data()"></select>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Data</label>
									<div class="col-sm-10" id="E_data_container">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Tahun</label>
									<div class="col-sm-10">
										<input type="text"  class="form-control" name="E_tahun">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Bulan</label>
									<div class="col-sm-10">
										<input type="text"  class="form-control" name="E_bulan">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Aktif</label>
									<div class="col-sm-10">
										<input type="text"  class="form-control" name="E_aktif">
									</div>
								</div>

							</div>
						</div>
						<div class="modal-footer">
							<button type="button" onclick="saveEditModal()" class="btn btn-sm btn-xs btn-success pull-right"><i class="fa fa-save"></i> Simpan</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="inputModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<form action="#" class="form-horizontal" method="POST">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">×</span></button>
							<h4 class="modal-title">Input Data Bulan Ini </h4>
						</div>
						<div class="modal-body">
							<div class="box-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">Bulan - Tahun</label>
									<div class="col-sm-3">
										<input type="text" disabled="" class="form-control" name="A_bulan" value="<?php echo $par_bulan; ?>">
									</div>
									<div class="col-sm-7">
										<input type="text" disabled="" class="form-control" name="A_tahun" value="<?php echo $par_tahun; ?>">
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Dapen</label>
									<div class="col-sm-10">
										<input type="hidden" name="A_id_dapen">
										<select id="A_FK_id_dapen" onchange="submit_a_fk_id_dapen()"></select>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label">Jenis Data</label>
									<div class="col-sm-10">

										<table class="table table-striped" id="tblDataInput">
											<thead>
												<tr>
													<th style="width: 10px">No</th>
													<th style="width: 250px">Jenis</th>
													<th>Data</th>
													<th>Aksi</th>
												</tr>
											</thead>
											<tbody>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>

	<?php $this->load->view('t_footer'); ?>
	</div>
	<?php $this->load->view('t_foot'); ?>
	<script>

		$(function () {
			loadDataTable();
			loadMaskMoney();

			<?php if($flag){ echo 'inputModal();';} ?>
		})

		$('.input_number').on('keyup', function() {
				if($(this).val()<0 || $(this).val()=='' ){$(this).val(0);}
				else if($(this).val()>100){$(this).val(100);}
		});

		function reloadTable() {
			loadDataTable();
		}

		function loadMaskMoney(){
			$('.maskMoney').maskMoney({thousands:'.', decimal:',', allowZero:true, prefix: 'Rp'});
			$('.maskMoney').each(function(){$(this).maskMoney('mask', $(this).val());})
		}

		function loadDataTable(){
			var wh = $(window).height() - 285;
			$('#listDataTable').dataTable({
					"scrollX"     : false,
					"scrollY"     : wh,
					"bDestroy"      : true,
					"stateSave"     : false,
					"searching"       : true,
					"select"          : true,
					//"bLengthChange"   : true,
					"scrollCollapse"  : true,
					"bPaginate"       : true,
					"bInfo"           : true,
					"bSort"           : false,
					"aLengthMenu"   : [[30, 50, 75, -1], [30, 50, 75, "All"]],
					"pageLength"    : 30,
					"processing"      : true, //Feature control the processing indicator.
					"serverSide"    : true, //Feature control DataTables' server-side processing mode.
					"order"       : [], //Initial no order.
					//"dom"               : 'Bfrtip',
					//"buttons"     : ['copy', 'csv', 'excel', 'pdf', 'print'],
					"fixedColumns":   {
					leftColumns: 2,
					rightColumns: 0
					},
					"ajax": {
					"url" : "<?php echo base_url('main/data/get_data/'.$par_bulan.'/'.$par_tahun);?>",
					"type"  : "POST",
					"dataSrc": function ( json ) {
						//$('#btn_add_project').prop("disabled", false);
						//alert("Done!");
						return json.data;
					}
					},
					"language": {
					"processing": "<center><p><img src='<?php echo base_url('assets/img/loader.gif');?>' /> Please Wait</p></center>"
					},
					"autoWidth": true,
					"columnDefs" : [
					{ 
						"targets" : [ 0 ], //first column / numbering column
						"orderable" : false, //set not orderable
					}
				]
			});
		}

		function inputModal(){
			$.getJSON('<?php echo base_url('main/data/get_data_input/'.$par_bulan.'/'.$par_tahun);?>', function(data)
			{
				if(data != null){

				$("#tblDataInput").find('tbody').empty();
					if(data.length>0){
						for (var i = 0; i < data.length; i++) {
							A_inputData = '';
							A_inputData += '<tr>';
							A_inputData += '<td>'+(i+1)+'</td>';
							A_inputData += '<td>'+data[i].nama_data+'</td>';
							if(data[i].aktif==null){
								if(data[i].simbol=='integer'){
									A_inputData += '<td><input type="text" class="form-control" name="A_'+data[i].id_data+'" value="0"></td>';
								}else if(data[i].simbol=='percent'){
									A_inputData += '<td><div class="input-group">'+
																		'<input type="number" min="0" max="100" class="form-control input_number" name="A_'+data[i].id_data+'" value="0" >'+
																		'<span class="input-group-addon" style="padding: 0px 12px">%</span>'+
																	'</div></td>';
								}else if(data[i].simbol=='money'){
									A_inputData += '<td><input type="text" class="form-control maskMoney" name="A_'+data[i].id_data+'" ></td>';
								}
								A_inputData += '<td><button type="button" onclick="addData(\''+data[i].id_data+'\')" class="btn btn-xs btn-primary"><i class="fa fa-plus"></i> Tambah</button></td>';
							}else{
								if(data[i].simbol=='integer'){
									A_inputData += '<td><input type="text" class="form-control" name="A_'+data[i].id_data+'" value="'+data[i].data+'"></td>';
								}else if(data[i].simbol=='percent'){
									A_inputData += '<td><div class="input-group">'+
																		'<input type="number" min="0" max="100" class="form-control input_number" name="A_'+data[i].id_data+'" value="'+data[i].data+'" >'+
																		'<span class="input-group-addon" style="padding: 0px 12px">%</span>'+
																	'</div></td>';
								}else if(data[i].simbol=='money'){
									A_inputData += '<td><input type="text" class="form-control maskMoney" name="A_'+data[i].id_data+'" value="'+data[i].data+'"></td>';
								}
								A_inputData += '<td><button type="button" onclick="saveEdit(\''+data[i].id_data+'\',\''+data[i].id_report+'\')" class="btn btn-xs btn-success"><i class="fa fa-save"></i> Simpan</button></td>';
							}

							A_inputData += '</tr>';

							$("#tblDataInput").find('tbody').append(A_inputData);
						}
					}else{
						$("#tblDataInput").find('tbody').append('<tr><td colspan="6" style="text-align: center;"><i>Tidak ada data</i></td></tr>');
					}

					$('#inputModal').modal({backdrop: 'static',keyboard: false,show: 'true'});
					<?php
						if($this->session->userdata('stpn_simva_session')['jenis']==1){
							echo 'get_a_fk_id_dapen();'; 
						}else{
							echo 'get_a_fk_id_dapen('.$this->session->userdata('stpn_simva_session')['id_dapen'].');'; 
							echo "$('#A_FK_id_dapen').prop('disabled', 'disabled');"; 
							echo '$("input[name=A_id_dapen]").val('.$this->session->userdata('stpn_simva_session')['id_dapen'].');'; 
					}?>
					loadMaskMoney();
				}else{
					console.log('no data');
				}
			});
		}

		function viewModal(id){
		$.getJSON('<?php echo base_url('main/data/get_data_single/');?>'+id, function(data)
		{
			if(data != null){
				$("input[name=V_id_report]").val(data.id_report);
				$("input[name=V_id_data]").val(data.id_data);
				$("input[name=V_id_dapen]").val(data.id_dapen);
				$("input[name=V_data]").val(data.data);
				$("input[name=V_tahun]").val(data.tahun);
				$("input[name=V_bulan]").val(data.bulan);
				$("input[name=V_aktif]").val(data.aktif);
				$('#viewModal').modal('show');
			}else{
				console.log('no data');
			}
		});
		}

		function editModal(id){
		$.getJSON('<?php echo base_url('main/data/get_data_single/');?>'+id, function(data)
		{
			if(data != null){
				get_e_fk_id_data(data.id_data);
				get_e_fk_id_dapen(data.id_dapen);

				$("input[name=E_id_report]").val(data.id_report);
				$("input[name=E_id_data]").val(data.id_data);
				$("input[name=E_id_dapen]").val(data.id_dapen);
				
				$("#E_data_container").empty();
				E_inputData = '';
				if(data.simbol=='integer'){
					E_inputData += '<td><input type="text" class="form-control" name="E_data" value="'+data.data+'"></td>';
				}else if(data.simbol=='percent'){
					E_inputData += '<td><div class="input-group">'+
														'<input type="number" min="0" max="100" class="form-control input_number" name="E_data" value="'+data.data+'" >'+
														'<span class="input-group-addon" style="padding: 0px 12px">%</span>'+
													'</div></td>';
				}else if(data.simbol=='money'){
					E_inputData += '<td><input type="text" class="form-control maskMoney" name="E_data" value="'+data.data+'" ></td>';
				}
				$("#E_data_container").append(E_inputData);

				$("input[name=E_tahun]").val(data.tahun);
				$("input[name=E_bulan]").val(data.bulan);
				$("input[name=E_aktif]").val(data.aktif);
				$('#editModal').modal('show');
				loadMaskMoney();
			}
			else{
				console.log('no data');
			}
		});
		}
	
		function addData(id_data){
			$('#tblDataInput tbody tr td button').attr('disabled','disabled');
			str = $("[name=A_"+id_data+"]").val();
			if(str.includes("Rp")){
				data = $("[name=A_"+id_data+"]").maskMoney('unmasked')[0];
			}else{
				data = $("[name=A_"+id_data+"]").val();
			}
			$.post('<?php echo base_url('main/data/add_data/');?>',
			{
				id_data : id_data,
				id_dapen : $("[name=A_id_dapen]").val(),
				data : data,
				tahun : $("input[name=A_tahun]").val(),
				bulan : $("input[name=A_bulan]").val(),
			},
			function(data,status){
				Swal.fire(
					'Berhasil',
					'Data berhasil ditambahkan',
					'success'
				);
				inputModal();
			});
		}

		function saveEdit(id_data,id_report){
			$('#tblDataInput tbody tr td button').attr('disabled','disabled');
			str = $("[name=A_"+id_data+"]").val();
			if(str.includes("Rp")){
				data = $("[name=A_"+id_data+"]").maskMoney('unmasked')[0];
			}else{
				data = $("[name=A_"+id_data+"]").val();
			}
			$.post('<?php echo base_url('main/data/update_data/');?>',
			{
				id_data : id_data,
				id_report : id_report,
				id_dapen : $("[name=A_id_dapen]").val(),
				data : data,
				tahun : $("input[name=A_tahun]").val(),
				bulan : $("input[name=A_bulan]").val(),
			},
			function(data,status){
				Swal.fire(
					'Berhasil',
					'Perubahan berhasil disimpan',
					'success'
				)
				inputModal();
			});
		}

		function saveEditModal(id_data,id_report){
			str = $("[name=E_data").val();
			if(str.includes("Rp")){
				data = $("[name=E_data").maskMoney('unmasked')[0];
			}else{
				data = $("[name=E_data").val();
			}
			$.post('<?php echo base_url('main/data/update_data/');?>',
			{
				id_data : id_data,
				id_report : id_report,
				id_dapen : $("[name=E_id_dapen]").val(),
				data : data,
				tahun : $("input[name=E_tahun]").val(),
				bulan : $("input[name=E_bulan]").val(),
			},
			function(data,status){
				Swal.fire(
					'Berhasil',
					'Perubahan berhasil disimpan',
					'success'
				)
				inputModal();
				loadDataTable();
			});
		}

		function deleteData(id){
			Swal.fire({
				title: 'Hapus data ini?',
				type: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#00a65a',
				cancelButtonColor: '#dd4b39',
				confirmButtonText: 'Hapus Data',
				cancelButtonText: "Batal",
			}).then((result) => {
				if (result.value) {
				$.post('<?php echo base_url('main/data/delete_data/');?>',
				{
					id_report : id
				},
				function(data,status){
					Swal.fire(
						'Berhasil',
						'Data berhasil dihapus',
						'success'
					)
					loadDataTable();
					$('#deleteModal').modal('hide');
				});
				}else{
					Swal.fire(
						'Batal',
						'',
						'error'
				)
				}
			})
		}

	/* ---- EDIT FK_id_data ------------------------------------------------------------------------------------- */
	function get_e_fk_id_data(id){
		$.getJSON('<?php echo base_url('main/data/get_fk_id_data/');?>', function(data)
		{
			if(data != null){
				$("#E_FK_id_data option").remove();
				$("#E_FK_id_data").append($("<option></option>").text('-').val('0'));
				$.each(data, function(index, item) {
					eachText = item.nama_data;
						$("#E_FK_id_data").append(
								$("<option></option>").text(eachText).val(item.id_data)
						);
				});
				$('#E_FK_id_data option[value="' + id +'"]').prop("selected", true);
			}
			else{
				console.log('no data');
			}
		});
	}

	function submit_e_fk_id_data(){
		$("input[name=E_id_data]").val($("#E_FK_id_data").val());
	}

	/* ---- ADD FK_id_dapen ------------------------------------------------------------------------------------- */
	function get_a_fk_id_dapen(id){
		$.getJSON('<?php echo base_url('main/data/get_fk_id_dapen/');?>', function(data)
		{
			if(data != null){
				$("#A_FK_id_dapen option").remove();
				$("#A_FK_id_dapen").append($("<option></option>").text('-').val('0'));
				$.each(data, function(index, item) {
					eachText = item.nama_dapen;
						$("#A_FK_id_dapen").append(
								$("<option></option>").text(eachText).val(item.id_dapen)
						);
				});
				$('#A_FK_id_dapen option[value="' + id +'"]').prop("selected", true);
			}
			else{
				console.log('no data');
			}
		});
	}

	function submit_a_fk_id_dapen(){
		$("input[name=A_id_dapen]").val($("#A_FK_id_dapen").val());
	}

	/* ---- EDIT FK_id_dapen ------------------------------------------------------------------------------------- */
	function get_e_fk_id_dapen(id){
		$.getJSON('<?php echo base_url('main/data/get_fk_id_dapen/');?>', function(data)
		{
			if(data != null){
				$("#E_FK_id_dapen option").remove();
				$("#E_FK_id_dapen").append($("<option></option>").text('-').val('0'));
				$.each(data, function(index, item) {
					eachText = item.nama_dapen;
						$("#E_FK_id_dapen").append(
								$("<option></option>").text(eachText).val(item.id_dapen)
						);
				});
				$('#E_FK_id_dapen option[value="' + id +'"]').prop("selected", true);
			}
			else{
				console.log('no data');
			}
		});
	}

	function submit_e_fk_id_dapen(){
		$("input[name=E_id_dapen]").val($("#E_FK_id_dapen").val());
	}

	</script>
	</body>
</html>
